#!/usr/bin/env ruby
# encoding: utf-8
# attach to a tmux session as new client (like screen)

Session = ARGV[0]
Name    = File.basename($PROGRAM_NAME)

# exit with 'message' as error message
def die(message)
  $stderr.puts message
  exit 1
end

# true if session exists, false otherwise
def session_exists?
  output = `tmux ls | grep "^#{Session}"`
  !output.empty?
end

# attach the session with a new, unique name
def attach_session
  puts "Launching copy of #{Session}"

  # Use epoch as a uniqe name
  new_session = Time.now.to_i
  `tmux new -dt #{Session} -s #{new_session}`

  # attach and destroy once orphaned
  exec("tmux attach -t #{new_session} \\; set destroy-unattached")
end

# -- main --

die("Usage: #{Name} session-name") if     Session.nil?
die("No such session #{Session}")  unless session_exists?
die('Detected running session')    unless ENV['TMUX'].nil?

attach_session
