#!/bin/sh
set -eu

clipboard() {
  xclip -selection c
  notify-send --icon=gtk-paste "Copied to clipboard."
}

password_store="$HOME/.password-store"

if ! test -d "$password_store"; then
    echo "Configure \$password_store within $(command -v passmenu-login)." 1>&2
    echo "Its default location, $password_store, does not exist." 1>&2
    exit 1
fi

candidates="$(find "$password_store/web" -name '*gpg' -print0 |
tr "\\0" "\\n" |
sed "s#$password_store/##;s#\\.gpg\$##")"

choice="$(printf "%s" "$candidates" | sort | dmenu -i -p 'pass-login' )"

if test -n "$choice"; then
    echo "Using $choice." 1>&2
    pass "$choice" | grep '^login:' | awk '{ print $2 }' | clipboard
else
    echo "Nothing choosen." 1>&2
fi
